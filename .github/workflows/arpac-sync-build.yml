name: ARPAC Sync and Build

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      px4_version:
        description: 'PX4 version tag to sync with (e.g., v1.16.0)'
        required: true
        default: 'v1.16.0'

  # Check for new releases weekly
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.check.outputs.new_version }}
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for new PX4 release
        id: check
        run: |
          # Get latest PX4 release tag
          LATEST=$(curl -s https://api.github.com/repos/PX4/PX4-Autopilot/releases/latest | jq -r .tag_name)
          echo "Latest PX4 release: $LATEST"

          # For manual dispatch, use the input version
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            LATEST="${{ github.event.inputs.px4_version }}"
            echo "Manual trigger with version: $LATEST"
          fi

          # Check if we already have this version
          if git tag | grep -q "arpac-${LATEST}"; then
            echo "Already have arpac-${LATEST}, skipping"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "New version found: $LATEST"
            echo "new_version=$LATEST" >> $GITHUB_OUTPUT
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  sync-and-build:
    needs: check-upstream
    if: needs.check-upstream.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ARPAC fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/PX4/PX4-Autopilot.git || true
          git fetch upstream --tags

      - name: Create ARPAC branch from upstream tag
        env:
          PX4_VERSION: ${{ needs.check-upstream.outputs.new_version }}
        run: |
          # Save ARPAC board files
          mkdir -p /tmp/arpac-backup
          cp -r boards/arpac /tmp/arpac-backup/ 2>/dev/null || true
          cp -r examples/regpeek /tmp/arpac-backup/ 2>/dev/null || true
          cp -r examples/sepeek /tmp/arpac-backup/ 2>/dev/null || true
          cp -r .github/workflows/arpac-sync-build.yml /tmp/arpac-backup/ 2>/dev/null || true

          # Checkout upstream tag
          git checkout "${PX4_VERSION}"
          git submodule update --init --recursive

          # Create new ARPAC branch
          git checkout -b "arpac-${PX4_VERSION}"

          # Restore ARPAC board files
          cp -r /tmp/arpac-backup/arpac boards/ 2>/dev/null || true
          mkdir -p examples
          cp -r /tmp/arpac-backup/regpeek examples/ 2>/dev/null || true
          cp -r /tmp/arpac-backup/sepeek examples/ 2>/dev/null || true
          mkdir -p .github/workflows
          cp /tmp/arpac-backup/arpac-sync-build.yml .github/workflows/ 2>/dev/null || true

          # Commit ARPAC patches
          git add -A
          git commit -m "Add ARPAC board patches for ${PX4_VERSION}" || echo "No changes to commit"

      - name: Install PX4 build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            ninja-build \
            exiftool \
            astyle \
            build-essential \
            ccache \
            cmake \
            cppcheck \
            file \
            g++ \
            gcc \
            gdb \
            git \
            lcov \
            libfuse2 \
            libxml2-dev \
            libxslt1-dev \
            make \
            openjdk-11-jdk \
            openjdk-11-jre \
            python3 \
            python3-dev \
            python3-pip \
            python3-venv \
            rsync \
            shellcheck \
            unzip \
            xsltproc \
            zip

      - name: Install ARM toolchain
        run: |
          # Download ARM toolchain
          wget -q https://developer.arm.com/-/media/Files/downloads/gnu/12.2.rel1/binrel/arm-gnu-toolchain-12.2.rel1-x86_64-arm-none-eabi.tar.xz
          sudo tar -xf arm-gnu-toolchain-12.2.rel1-x86_64-arm-none-eabi.tar.xz -C /opt/
          echo "/opt/arm-gnu-toolchain-12.2.rel1-x86_64-arm-none-eabi/bin" >> $GITHUB_PATH

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install kconfiglib jinja2 "empy==3.3.4" jsonschema pyros-genmsg packaging toml numpy future pyyaml cerberus

      - name: Build ARPAC board (default)
        run: |
          export PATH="/opt/arm-gnu-toolchain-12.2.rel1-x86_64-arm-none-eabi/bin:$PATH"
          make arpac_arpac-drone_default

      - name: Build ARPAC board (cryptotest)
        run: |
          export PATH="/opt/arm-gnu-toolchain-12.2.rel1-x86_64-arm-none-eabi/bin:$PATH"
          make arpac_arpac-drone_cryptotest
        continue-on-error: true

      - name: Push ARPAC branch
        env:
          PX4_VERSION: ${{ needs.check-upstream.outputs.new_version }}
        run: |
          git push origin "arpac-${PX4_VERSION}" --force

      - name: Create tag
        env:
          PX4_VERSION: ${{ needs.check-upstream.outputs.new_version }}
        run: |
          git tag "arpac-${PX4_VERSION}"
          git push origin "arpac-${PX4_VERSION}" --force

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: arpac-firmware-${{ needs.check-upstream.outputs.new_version }}
          path: |
            build/arpac_arpac-drone_default/*.px4
            build/arpac_arpac-drone_cryptotest/*.px4
          if-no-files-found: warn

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: arpac-${{ needs.check-upstream.outputs.new_version }}
          name: ARPAC Drone Firmware ${{ needs.check-upstream.outputs.new_version }}
          body: |
            ARPAC Drone firmware based on PX4 ${{ needs.check-upstream.outputs.new_version }}

            ## Changes from upstream PX4
            - Custom IMU configuration (ICM45686, IIM42653, ICM42670P)
            - MS5837 barometer support
            - Crypto/heater support
            - Custom debug modules (regpeek, sepeek)

            ## Build artifacts
            - `arpac_arpac-drone_default.px4` - Main firmware
            - `arpac_arpac-drone_cryptotest.px4` - Crypto test firmware
          files: |
            build/arpac_arpac-drone_default/*.px4
            build/arpac_arpac-drone_cryptotest/*.px4
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
